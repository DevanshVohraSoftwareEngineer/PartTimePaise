# PartTimePaise - Task Marketplace Queries
# Integrated with Firebase Auth and real-time capabilities

# Get current user profile
query GetCurrentUser @auth(level: USER) {
  user(key: { id_expr: "auth.uid" }) {
    id
    email
    name
    role
    avatarUrl
    bio
    latitude
    longitude
    city
    phone
    rating
    verified
    walletBalance
    college
    completedTasks
    skills
    createdAt
    updatedAt
  }
}

# List all open tasks with client info (for task feed)
query ListOpenTasks @auth(level: PUBLIC, insecureReason: "Anyone can browse available tasks") {
  tasks(where: { status: { eq: "open" } }, orderBy: [{ createdAt: DESC }]) {
    id
    title
    description
    category
    budget
    budgetType
    deadline
    urgency
    status
    latitude
    longitude
    location
    imageUrl
    images
    createdAt
    updatedAt
    client {
      id
      name
      avatarUrl
      rating
      verified
      city
    }
  }
}

# Get task details with bids and client info
query GetTaskDetails($taskId: UUID!) @auth(level: PUBLIC, insecureReason: "Anyone can view task details") {
  task(id: $taskId) {
    id
    title
    description
    category
    budget
    budgetType
    deadline
    urgency
    status
    latitude
    longitude
    location
    imageUrl
    images
    createdAt
    updatedAt
    client {
      id
      name
      avatarUrl
      rating
      verified
      city
      phone
    }
    bids_on_task {
      id
      amount
      message
      status
      createdAt
      worker {
        id
        name
        avatarUrl
        rating
        skills
      }
    }
  }
}

# Get user's posted tasks
query GetUserPostedTasks @auth(level: USER) {
  user(key: { id_expr: "auth.uid" }) {
    id
    name
    tasks_on_client(orderBy: [{ createdAt: DESC }]) {
      id
      title
      description
      category
      budget
      status
      createdAt
      bids_on_task {
        id
        amount
        status
        worker {
          id
          name
          avatarUrl
          rating
        }
      }
    }
  }
}

# Get user's bids and applications
query GetUserBids @auth(level: USER) {
  user(key: { id_expr: "auth.uid" }) {
    id
    name
    bids_on_worker(orderBy: [{ createdAt: DESC }]) {
      id
      amount
      message
      status
      createdAt
      task {
        id
        title
        category
        budget
        status
        client {
          id
          name
          avatarUrl
        }
      }
    }
  }
}

# Get user's active matches (both as worker and client)
query GetUserMatches @auth(level: USER) {
  user(key: { id_expr: "auth.uid" }) {
    id
    name
    # Matches where user is worker
    taskMatches_on_worker(orderBy: [{ matchedAt: DESC }]) {
      id
      status
      matchedAt
      task {
        id
        title
        category
        budget
        status
        client {
          id
          name
          avatarUrl
        }
      }
    }
    # Matches where user is client
    taskMatches_on_client(orderBy: [{ matchedAt: DESC }]) {
      id
      status
      matchedAt
      task {
        id
        title
        category
        budget
        status
      }
      worker {
        id
        name
        avatarUrl
        rating
      }
    }
  }
}

# Get messages for a specific match
query GetMatchMessages($matchId: UUID!) @auth(level: USER) {
  taskMatches(where: { id: { eq: $matchId } }) {
    id
    status
    task {
      id
      title
    }
    worker {
      id
      name
      avatarUrl
    }
    client {
      id
      name
      avatarUrl
    }
  }
  messages(where: { matchId: { eq: $matchId } }, orderBy: [{ createdAt: ASC }]) {
    id
    content
    messageType
    read
    createdAt
    senderId
  }
}

# Get user's notifications
query GetUserNotifications @auth(level: USER) {
  user(key: { id_expr: "auth.uid" }) {
    notifications_on_user(orderBy: [{ createdAt: DESC }], limit: 50) {
      id
      title
      message
      type
      read
      data
      createdAt
    }
  }
}

# Search tasks by filters
query SearchTasks(
  $category: String,
  $minBudget: Float,
  $maxBudget: Float,
  $location: String,
  $limit: Int = 20
) @auth(level: PUBLIC, insecureReason: "Anyone can search tasks") {
  tasks(
    where: {
      status: { eq: "open" }
      category: { eq: $category }
      budget: { ge: $minBudget, le: $maxBudget }
      location: { contains: $location }
    },
    orderBy: [{ createdAt: DESC }],
    limit: $limit
  ) {
    id
    title
    description
    category
    budget
    budgetType
    location
    imageUrl
    createdAt
    client {
      id
      name
      avatarUrl
      rating
      verified
    }
  }
}

# Get nearby tasks (would need location-based filtering)
query GetNearbyTasks($latitude: Float!, $longitude: Float!, $radiusKm: Float = 10.0)
@auth(level: PUBLIC, insecureReason: "Anyone can browse nearby tasks") {
  tasks(
    where: {
      status: { eq: "open" }
      latitude: { isNull: false }
      longitude: { isNull: false }
    },
    orderBy: [{ createdAt: DESC }]
  ) {
    id
    title
    category
    budget
    latitude
    longitude
    location
    createdAt
    client {
      id
      name
      avatarUrl
      rating
    }
  }
}
